name: Update arXiv Papers

on:
  schedule:
    - cron: "0 0 * * *"  # daily at midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 requests

      - name: Debug arXiv API fetch (runner) with retries
        run: |
          set -euo pipefail

          URL="https://export.arxiv.org/api/query?search_query=au:Ruben+Lier&start=0&max_results=100"
          UA="rubenlier.nl arXiv-scraper/1.0 (contact: ruben.lier@email.com)"

          OUT_XML="debug_arxiv.xml"
          HDRS="debug_arxiv.headers"

          max_attempts=8
          base_sleep=3

          echo "URL=$URL"

          for attempt in $(seq 1 "$max_attempts"); do
            echo "Attempt $attempt/$max_attempts"

            code="$(curl -sS -L \
              -H "User-Agent: $UA" \
              -D "$HDRS" -o "$OUT_XML" \
              -w '%{http_code}' \
              "$URL" || echo "000")"

            echo "HTTP=$code"
            n="$(grep -c '<entry>' "$OUT_XML" || true)"
            echo "entry count=$n"

            if [[ "$code" == "200" && "$n" -gt 0 ]]; then
              echo "OK"
              break
            fi

            echo "---- HEAD $OUT_XML ----"
            head -n 80 "$OUT_XML" || true
            echo "---- END HEAD ----"

            if [[ "$code" == "429" || "$code" == "500" || "$code" == "502" || "$code" == "503" || "$code" == "504" || "$code" == "000" ]]; then
              retry_after="$(awk 'BEGIN{IGNORECASE=1} /^Retry-After:/ {gsub("\r",""); print $2}' "$HDRS" | tail -n 1)"
              if [[ -n "${retry_after:-}" ]]; then
                sleep_s="$retry_after"
              else
                exp=$(( base_sleep * (2 ** (attempt - 1)) ))
                jitter=$(( RANDOM % 3 ))   # 0â€“2s
                sleep_s=$(( exp + jitter ))
                if (( sleep_s > 120 )); then sleep_s=120; fi
              fi
              echo "Retrying after ${sleep_s}s..."
              sleep "$sleep_s"
              continue
            fi

            echo "Non-retriable HTTP status: $code"
            exit 1
          done

          if [[ "${code:-}" != "200" ]]; then
            echo "Failed after $max_attempts attempts (last HTTP=$code)"
            exit 1
          fi

          # If it was 200 but entries are still 0, fail loudly (usually indicates not Atom feed)
          if [[ "$(grep -c '<entry>' "$OUT_XML" || true)" -eq 0 ]]; then
            echo "HTTP 200 but no <entry> elements found; refusing to continue."
            exit 1
          fi

      - name: Run script to fetch arXiv papers
        env:
          ARXIV_USER_AGENT: "rubenlier.nl arXiv-scraper/1.0 (contact: ruben.lier@email.com)"
        run: |
          python fetch_arxiv.py

      - name: Touch paper.html (force visible last-updated stamp)
        run: |
          set -euo pipefail
          TS="$(TZ=Europe/Amsterdam date '+%Y-%m-%d %H:%M (Amsterdam)')"

          # Keep a single visible line at the top of paper.html.
          # If it's already there, replace it; otherwise prepend it.
          if grep -q 'id="preprints-last-updated"' paper.html; then
            perl -0777 -i -pe 's#<div id="preprints-last-updated">.*?</div>#<div id="preprints-last-updated"><em>Last updated: '"$TS"'</em></div>#s' paper.html
          else
            tmp="$(mktemp)"
            {
              echo '<div id="preprints-last-updated"><em>Last updated: '"$TS"'</em></div>'
              cat paper.html
            } > "$tmp"
            mv "$tmp" paper.html
          fi

      - name: Commit and push if updated
        run: |
          set -euo pipefail
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          git add paper.html

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update arXiv papers in paper.html"
          git push
