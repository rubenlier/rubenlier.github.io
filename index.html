<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruben's Profile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #fff; color: #333; }

        .navbar {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
            justify-content: flex-start;
        }
        .navbar-inner { margin-left: 250px; }
        .navbar a {
            text-decoration: none;
            color: #333;
            font-size: 1em;
            margin-right: 20px;
        }
        .navbar a.active { font-weight: bold; }
        .navbar a:hover { text-decoration: underline; }

        .layout { display: flex; height: calc(100vh - 60px); }

        .sidebar {
            width: 250px;
            border-right: 1px solid #ccc;
            padding: 20px;
        }
        .sidebar img { width: 100%; margin-bottom: 20px; }

        .social-links { list-style: none; padding: 0; }
        .social-links li { margin-bottom: 15px; }
        .social-links a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333;
        }
        .social-links a img {
            width: 14px;
            height: 14px;
            margin-right: 10px;
            position: relative;
            top: 10px;
        }

        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .content h1 { font-size: 2em; margin-bottom: 10px; }
        .content p { font-size: 1.2em; line-height: 1.6; margin-bottom: 20px; }
        .simulation-image { max-width: 100%; border: 1px solid #ccc; margin-top: 20px; }

        .paper { margin: 16px 0; }
        .paper h3 { margin-bottom: 4px; }
        .bold { font-weight: bold; }

        /* Talks map */
        .map-container { position: relative; width: 100%; max-width: none; margin-top: 20px; }
        .world-map { width: 100%; display: block; }
        .flag-emoji { position: absolute; cursor: pointer; transform: translate(-50%, -50%); }
        .flag-emoji::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 120%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-in-out;
        }
        .flag-emoji:hover::after { opacity: 1; }

        /* Beta Holden history */
        .holden-form { display: flex; gap: 10px; margin-bottom: 0.75rem; }
        .holden-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .holden-button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            background-color: #222;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
        }
        .holden-button:disabled { opacity: 0.6; cursor: default; }
        .holden-status { min-height: 1.2em; font-size: 0.9rem; color: #777; }
        .holden-output { margin-top: 20px; }
        .holden-image-wrapper { display: flex; align-items: flex-start; gap: 16px; }
        .holden-image {
            max-width: 220px;
            height: auto;
            flex-shrink: 0;
            border-radius: 50%;
            object-fit: cover;
        }
        .holden-speech-bubble {
            position: relative;
            background: #f5f5f5;
            border-radius: 16px;
            padding: 12px 14px;
            max-width: 100%;
            min-height: 80px;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 1px solid #ddd;
        }
        .holden-speech-bubble::before {
            content: "";
            position: absolute;
            left: -12px;
            top: 40%;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 12px solid #f5f5f5;
        }
        .holden-speech-bubble::after {
            content: "";
            position: absolute;
            left: -13px;
            top: 40%;
            border-top: 9px solid transparent;
            border-bottom: 9px solid transparent;
            border-right: 13px solid #ddd;
        }
        .holden-response { white-space: pre-wrap; word-wrap: break-word; }

        @media (max-width: 600px) {
            .holden-image-wrapper { flex-direction: column; align-items: center; }
            .holden-speech-bubble { margin-top: 10px; }
            .holden-speech-bubble::before,
            .holden-speech-bubble::after {
                left: 30px;
                top: -14px;
                border-right: 8px solid transparent;
                border-left: 8px solid transparent;
                border-bottom: 12px solid #f5f5f5;
            }
            .holden-speech-bubble::after { top: -15px; border-bottom-color: #ddd; }
        }

        .holden-history { margin-top: 14px; border-top: 1px solid #eee; padding-top: 12px; }
        .holden-history-item {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .holden-history-date { font-size: 0.85rem; color: #777; margin-bottom: 6px; }
        .holden-history-text { font-size: 0.95rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }

        /* World news */
        .news-meta { color: #666; font-size: 0.95rem; margin-bottom: 14px; }
        .news-list { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .news-card {
            border: 1px solid #e6e6e6;
            border-radius: 14px;
            padding: 14px 14px;
            background: #fff;
        }
        .news-title {
            font-size: 1.15rem;
            margin-bottom: 8px;
            line-height: 1.35;
        }
        .news-title a { color: #111; text-decoration: none; }
        .news-title a:hover { text-decoration: underline; }

        .news-kpis {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 14px;
            margin-top: 8px;
            color: #444;
            font-size: 0.95rem;
        }
        .kpi { background: #f6f6f6; border: 1px solid #eee; border-radius: 999px; padding: 6px 10px; }

        /* FAMILIER full-screen view */
        .familier-root {
            position: fixed;
            inset: 0;
            background-color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .familier-root img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-inner">
            <a href="#home" data-page="home">Ruben Lier</a>
            <a href="#preprints" data-page="preprints">Preprints</a>
            <a href="#talks" data-page="talks">Talks</a>
            <a href="#worldnews" data-page="worldnews">World news</a>
            <!-- Notice: no link to #beta or #familier here on purpose -->
        </div>
    </div>

    <!-- Layout -->
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <img src="foto save ruben.PNG" alt="Ruben's Picture">
            <ul class="social-links">
                <li><a href="https://www.uva.nl/en/profile/l/i/r.lier/r.lier.html" target="_blank">
                    <img src="uvalogo.png" alt="Contact"><span>Contact</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=jN3gPNkAAAAJ&hl=nl" target="_blank">
                    <img src="scholarlogo.png" alt="Google Scholar"><span>Google Scholar</span></a></li>
                <li><a href="https://nl.linkedin.com/in/ruben-lier-b228b2182" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png" alt="LinkedIn"><span>LinkedIn</span></a></li>
                <li><a href="https://www.goodreads.com/user/show/131725587-ruben-lier" target="_blank">
                    <img src="goodreads.png" alt="Goodreads"><span>Goodreads</span></a></li>
                <li><a href="https://github.com/rubenlier" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/GitHub_Invertocat_Logo.svg" alt="GitHub"><span>GitHub</span></a></li>
                <li><a href="https://open.spotify.com/playlist/4nSMm8TaDVlrNi4u9rzImQ" target="_blank">
                    <img src="spotify.png" alt="Spotify"><span>Spotify</span></a></li>
            </ul>
        </div>

        <!-- Main content -->
        <div class="content" id="content"></div>
    </div>

    <!-- FAMILIER full-screen picture -->
    <div id="familier-root" class="familier-root">
        <img src="familier.png" alt="Familier">
    </div>

    <script>
        // API endpoints (beta only)
        const HOLDEN_API_URL_BETA =
            "https://holden-hcaulfield-medium-416156146603.europe-west4.run.app/generate";

        // Pages are HTML snippets injected into #content
        const pages = {
            home: `
                <h1>About me</h1>
                <p>
                    I am a theoretical physicist at the University of Amsterdam, specialized in problems
                    related to hydrodynamics, ranging from astrophysics to condensed matter physics and
                    from biophysics to high-energy physics.
                </p>
                <p>
                    Click "Preprints" in the top bar to learn about my recent scientific work.
                    Click "Talks" to see all the talks I have given.
                </p>
                <p>
                    Below is an animation of a numerical simulation that was part of my
                    <a href="https://journals.aps.org/prd/abstract/10.1103/stvc-tzfh" target="_blank">work</a> on magnetohydrodynamics.
                </p>
                <img src="animation.gif" alt="Hydrodynamic simulation" class="simulation-image">
            `,

            preprints: `
                <h1>My latest arXiv preprints</h1>
                <div id="preprints-container">
                    Loading latest arXiv papersâ€¦
                </div>
            `,

            talks: `
                <h1>Talks</h1>
                <p>
                    Hover your mouse over the flags to see when and where I have given a talk.
                </p>
                <div class="map-container">
                    <img class="world-map" src="equirel.jpg" alt="World Map" />

                    <!-- Flags: formula used: 100*{(90 - y)/180 - 0.052, (180 + x)/360 - 0.01} -->
                    <div class="flag-emoji" style="top: 18.70%; left: 51.40%;" data-tooltip="Odd Viscoelasticity Workshop (DIEP) â€“ 1 April 2022">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.00%; left: 51.40%;" data-tooltip="NWO Physics â€“ 23 Feb 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.20%; left: 52.80%;" data-tooltip="Max Planck Institute for Dynamics and Self-Organization â€“ 17 Sep 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.40%; left: 53.80%;" data-tooltip="Max Planck Institute for the Physics of Complex Systems â€“ 21 Sep 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.40%; left: 54.70%;" data-tooltip="WrocÅ‚aw University of Science and Technology â€“ 24 Jan 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 14.80%; left: 55.00%;" data-tooltip="Hydrodynamics at all scales (Nordita) â€“ 8 Sep 2023">ðŸš©</div>
                    <div class="flag-emoji" style="top: 21.30%; left: 16.00%;" data-tooltip="University of Washington â€“ 22 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.90%; left: 14.70%;" data-tooltip="University of Victoria â€“ 26 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.40%; left: 15.80%;" data-tooltip="University of British Columbia â€“ 15 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 29.00%; left: 17.20%;" data-tooltip="APS Global Physics Summit â€“ 17 March 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 21.10%; left: 50.55%;" data-tooltip="Institut Curie â€“ 15 May 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 18.00%; left: 51.00%;" data-tooltip="DIEP Seminar (Amsterdam) â€“ 11 Sep 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 24.00%; left: 53.00%;" data-tooltip="UniversitÃ  di Genova â€“ 29 Oct 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 29.50%; left: 61.00%;" data-tooltip="Tel Aviv University â€“ 1 Dec 2025">ðŸš©</div>
                </div>
            `,

            worldnews: `
                <h1>World news</h1>
                <div class="news-meta" id="worldnews-meta">Loading top clustersâ€¦</div>
                <div class="news-list" id="worldnews-list"></div>
            `,

            // BETA PAGE (hidden route: #beta)
            beta: `
                <h1>Holdenator (beta)</h1>
                <p>Let Holden Caulfield finish your sentence.</p>

                <form id="holden-form" class="holden-form" autocomplete="off">
                    <input
                        id="holden-input"
                        class="holden-input"
                        type="text"
                        placeholder="If you really want to hear about it..."
                        required
                    />
                    <button type="submit" id="holden-submit" class="holden-button">
                        Talk to Holden
                    </button>
                </form>

                <p class="holden-status" id="holden-status"></p>

                <div class="holden-output">
                    <div class="holden-image-wrapper">
                        <img
                            src="holden.jpg"
                            alt="Holden Caulfield"
                            class="holden-image"
                        />
                        <div class="holden-speech-bubble">
                            <div id="holden-response" class="holden-response">
                                Iâ€™ll say something once you give me a prompt.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="holden-history" class="holden-history">
                    Loading historyâ€¦
                </div>
            `
        };

        async function loadPreprintsSnippet() {
            const container = document.getElementById('preprints-container');
            if (!container) return;

            try {
                const response = await fetch('paper.html', { cache: 'no-cache' });
                if (!response.ok) {
                    container.innerHTML = '<p>Could not load preprints at the moment.</p>';
                    return;
                }
                const html = await response.text();
                container.innerHTML = html;
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error loading preprints.</p>';
            }
        }

        // --- helpers ---
        function escapeHtml(s) {
            return (s || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function escapeRegExp(s) {
            return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        // --- World news loader ---
        async function loadWorldNews() {
            const metaEl = document.getElementById("worldnews-meta");
            const listEl = document.getElementById("worldnews-list");
            if (!metaEl || !listEl) return;

            metaEl.textContent = "Loading top clustersâ€¦";
            listEl.innerHTML = "";

            try {
                // You said you committed it as output.jsonl
                const res = await fetch("output.jsonl", { cache: "no-cache" });
                if (!res.ok) {
                    throw new Error(`Could not load output.jsonl (HTTP ${res.status})`);
                }

                const text = await res.text();

                // Support both:
                //  - single JSON object (your current output)
                //  - JSONL with one object per line
                let data = null;

                try {
                    data = JSON.parse(text);
                } catch (_) {
                    // try JSONL fallback: find first line that parses and has clusters
                    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                    for (const line of lines) {
                        try {
                            const obj = JSON.parse(line);
                            if (obj && Array.isArray(obj.clusters)) {
                                data = obj;
                                break;
                            }
                        } catch (e) {}
                    }
                }

                if (!data || !Array.isArray(data.clusters)) {
                    throw new Error("output.jsonl does not contain a JSON object with a 'clusters' array.");
                }

                const top = data.clusters.slice(0, 5);
                const inputPath = data.input_path || "output.jsonl";
                const nItems = Number.isFinite(data.n_items) ? data.n_items : null;
                const nClusters = Number.isFinite(data.n_clusters) ? data.n_clusters : null;

                metaEl.textContent =
                    `Showing 5 prominent events from ${escapeHtml(inputPath)}`
                    + (nItems !== null ? ` Â· items: ${nItems}` : "")
                    + (nClusters !== null ? ` Â· clusters: ${nClusters}` : "");

                listEl.innerHTML = top.map((c, idx) => {
                    const title = c.title || `Cluster ${idx + 1}`;
                    const score = (typeof c.score === "number") ? c.score.toFixed(2) : c.score;
                    const coherence = (typeof c.coherence === "number") ? c.coherence.toFixed(3) : c.coherence;

                    const ca = c.central_article || {};
                    const url = ca.url || "#";
                    const source = ca.source_id || "";
                    const continent = ca.continent || "";
                    const scraped = ca.scraped_at_utc || "";
                    const published = ca.published_at || "";

                    return `
                        <div class="news-card">
                            <div class="news-title">
                                <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
                                    ${escapeHtml(title)}
                                </a>
                            </div>

                            <div class="news-kpis">
                                <span class="kpi">score: ${escapeHtml(String(score))}</span>
                                <span class="kpi">size: ${escapeHtml(String(c.size ?? ""))}</span>
                                <span class="kpi">sources: ${escapeHtml(String(c.n_sources ?? ""))}</span>
                                <span class="kpi">continents: ${escapeHtml(String(c.n_continents ?? ""))}</span>
                                <span class="kpi">coherence: ${escapeHtml(String(coherence))}</span>
                            </div>

                            <div class="news-meta" style="margin-top:10px;">
                                <div>${escapeHtml(source)}${continent ? " Â· " + escapeHtml(continent) : ""}</div>
                                ${published ? `<div>published: ${escapeHtml(published)}</div>` : ""}
                                ${scraped ? `<div>scraped: ${escapeHtml(scraped)}</div>` : ""}
                            </div>
                        </div>
                    `;
                }).join("");

            } catch (err) {
                console.error(err);
                metaEl.textContent = "Could not load world news.";
                listEl.innerHTML = `<p style="color:#b00;">${escapeHtml(err.message || String(err))}</p>`;
            }
        }

        // --- Holden history rendering ---
        async function loadHoldenHistory() {
            const container = document.getElementById("holden-history");
            if (!container) return;

            try {
                const res = await fetch("holden_history.html", { cache: "no-cache" });
                if (!res.ok) {
                    container.innerHTML = "<p>Could not load history.</p>";
                    return;
                }

                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, "text/html");
                const items = Array.from(doc.querySelectorAll("li"));

                if (!items.length) {
                    container.innerHTML = "<p>No history yet.</p>";
                    return;
                }

                container.innerHTML = items.map(li => {
                    const date = (li.querySelector("strong")?.textContent || "").trim();
                    const liHtml = li.innerHTML;

                    const promptMatch = liHtml.match(/<em>\s*Prompt:\s*<\/em>\s*([\s\S]*?)<br\s*\/?>/i);
                    const holdenMatch = liHtml.match(/<em>\s*Holden:\s*<\/em>\s*([\s\S]*)$/i);

                    const prompt = promptMatch ? promptMatch[1].replace(/<[^>]*>/g, "").trim() : "";
                    const holdenHtml = holdenMatch ? holdenMatch[1].trim() : "";

                    const tmp = document.createElement("div");
                    tmp.innerHTML = holdenHtml;
                    const holdenTextRaw = (tmp.textContent || "").trim();

                    let rendered;
                    if (prompt && holdenTextRaw.startsWith(prompt)) {
                        rendered =
                            "<strong>" + escapeHtml(prompt) + "</strong>" +
                            escapeHtml(holdenTextRaw.slice(prompt.length));
                    } else if (prompt && holdenTextRaw.includes(prompt)) {
                        rendered = escapeHtml(holdenTextRaw).replace(
                            new RegExp(escapeRegExp(prompt)),
                            "<strong>" + escapeHtml(prompt) + "</strong>"
                        );
                    } else {
                        rendered = escapeHtml(holdenTextRaw);
                    }

                    return `
                        <div class="holden-history-item">
                            <div class="holden-history-date">${escapeHtml(date)}</div>
                            <div class="holden-history-text">${rendered}</div>
                        </div>
                    `;
                }).join("");

            } catch (err) {
                console.error(err);
                container.innerHTML = "<p>Error loading history.</p>";
            }
        }

        function initHoldenatorBetaPage() {
            const form = document.getElementById("holden-form");
            if (!form) return;

            const input = document.getElementById("holden-input");
            const button = document.getElementById("holden-submit");
            const responseEl = document.getElementById("holden-response");
            const statusEl = document.getElementById("holden-status");

            const apiUrl = HOLDEN_API_URL_BETA;

            form.addEventListener("submit", async (event) => {
                event.preventDefault();

                const prompt = input.value.trim();
                if (!prompt) return;

                button.disabled = true;
                statusEl.textContent = "Holden is thinking...";
                responseEl.textContent = "â€¦";

                try {
                    const res = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt })
                    });

                    if (!res.ok) {
                        const bodyText = await res.text().catch(() => "");
                        throw new Error(`HTTP ${res.status} ${res.statusText} â€“ ${bodyText}`);
                    }

                    const data = await res.json();
                    responseEl.textContent = data.text || "";
                    statusEl.textContent = "";
                } catch (err) {
                    console.error("Holdenator error:", err);
                    responseEl.textContent =
                        "Sorry, Holdenâ€™s having a breakdown and canâ€™t answer right now.";
                    statusEl.textContent = err.message || "Error talking to the API.";
                } finally {
                    button.disabled = false;
                }
            });
        }

        function setActiveLink(page) {
            document.querySelectorAll('.navbar a[data-page]').forEach(a => {
                if (a.dataset.page === page) a.classList.add('active');
                else a.classList.remove('active');
            });
        }

        function loadPage(page) {
            const navbar = document.querySelector('.navbar');
            const layout = document.querySelector('.layout');
            const familierRoot = document.getElementById('familier-root');
            const contentDiv = document.getElementById('content');

            // Special case: familier
            if (page === 'familier') {
                if (navbar) navbar.style.display = 'none';
                if (layout) layout.style.display = 'none';
                if (familierRoot) familierRoot.style.display = 'flex';
                return;
            }

            if (familierRoot) familierRoot.style.display = 'none';
            if (layout) layout.style.display = 'flex';

            if (!pages[page]) page = 'home';
            contentDiv.innerHTML = pages[page];

            if (page === 'beta') {
                if (navbar) navbar.style.display = 'none';
            } else {
                if (navbar) navbar.style.display = 'flex';
                setActiveLink(page);
            }

            if (page === 'preprints') {
                loadPreprintsSnippet();
            } else if (page === 'beta') {
                initHoldenatorBetaPage();
                loadHoldenHistory();
            } else if (page === 'worldnews') {
                loadWorldNews();
            }
        }

        function getPageFromHash() {
            const hash = window.location.hash.replace('#', '');
            return hash || 'home';
        }

        window.addEventListener('hashchange', () => {
            loadPage(getPageFromHash());
        });

        loadPage(getPageFromHash());
    </script>
</body>
</html>
