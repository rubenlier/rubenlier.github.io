<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruben's Profile</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #fff; color: #333; }

        .navbar {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #ccc;
            justify-content: flex-start;
        }
        .navbar-inner { margin-left: 250px; }
        .navbar a {
            text-decoration: none;
            color: #333;
            font-size: 1em;
            margin-right: 20px;
        }
        .navbar a.active { font-weight: bold; }
        .navbar a:hover { text-decoration: underline; }

        .layout { display: flex; height: calc(100vh - 60px); }

        .sidebar {
            width: 250px;
            border-right: 1px solid #ccc;
            padding: 20px;
        }
        .sidebar img { width: 100%; margin-bottom: 20px; }

        .social-links { list-style: none; padding: 0; }
        .social-links li { margin-bottom: 15px; }
        .social-links a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #333;
        }
        .social-links a img {
            width: 14px;
            height: 14px;
            margin-right: 10px;
            position: relative;
            top: 10px;
        }

        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .content h1 { font-size: 2em; margin-bottom: 10px; }
        .content p { font-size: 1.2em; line-height: 1.6; margin-bottom: 20px; }
        .simulation-image { max-width: 100%; border: 1px solid #ccc; margin-top: 20px; }

        .paper { margin: 16px 0; }
        .paper h3 { margin-bottom: 4px; }
        .bold { font-weight: bold; }

        /* Talks map */
        .map-container { position: relative; width: 100%; max-width: none; margin-top: 20px; }
        .world-map { width: 100%; display: block; }
        .flag-emoji { position: absolute; cursor: pointer; transform: translate(-50%, -50%); }
        .flag-emoji::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            bottom: 120%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-in-out;
        }
        .flag-emoji:hover::after { opacity: 1; }


        /* Talks flags: responsive sizing */
        .flag-emoji{
        font-size: clamp(14px, 2.2vw, 22px);
        line-height: 1;
        }

        /* Slightly smaller on narrow screens */
        @media (max-width: 820px){
        .flag-emoji{ font-size: clamp(12px, 4.2vw, 18px); }
        }

        /* Keep your current ::after tooltip styling, then add: */
        .flag-emoji.is-open::after { opacity: 1; }

        /* Phones/tablets: don't rely on hover at all */
        @media (hover: none){
        .flag-emoji:hover::after { opacity: 0; } /* disable hover behavior on touch devices */
        }


        /* Beta Holden history */
        .holden-form { display: flex; gap: 10px; margin-bottom: 0.75rem; }
        .holden-input {
            flex: 1;
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        .holden-button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            background-color: #222;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            white-space: nowrap;
        }
        .holden-button:disabled { opacity: 0.6; cursor: default; }
        .holden-status { min-height: 1.2em; font-size: 0.9rem; color: #777; }
        .holden-output { margin-top: 20px; }
        .holden-image-wrapper { display: flex; align-items: flex-start; gap: 16px; }
        .holden-image {
            max-width: 220px;
            height: auto;
            flex-shrink: 0;
            border-radius: 50%;
            object-fit: cover;
        }
        .holden-speech-bubble {
            position: relative;
            background: #f5f5f5;
            border-radius: 16px;
            padding: 12px 14px;
            max-width: 100%;
            min-height: 80px;
            font-size: 0.95rem;
            line-height: 1.4;
            border: 1px solid #ddd;
        }
        .holden-speech-bubble::before {
            content: "";
            position: absolute;
            left: -12px;
            top: 40%;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 12px solid #f5f5f5;
        }
        .holden-speech-bubble::after {
            content: "";
            position: absolute;
            left: -13px;
            top: 40%;
            border-top: 9px solid transparent;
            border-bottom: 9px solid transparent;
            border-right: 13px solid #ddd;
        }
        .holden-response { white-space: pre-wrap; word-wrap: break-word; }

        @media (max-width: 600px) {
            .holden-image-wrapper { flex-direction: column; align-items: center; }
            .holden-speech-bubble { margin-top: 10px; }
            .holden-speech-bubble::before,
            .holden-speech-bubble::after {
                left: 30px;
                top: -14px;
                border-right: 8px solid transparent;
                border-left: 8px solid transparent;
                border-bottom: 12px solid #f5f5f5;
            }
            .holden-speech-bubble::after { top: -15px; border-bottom-color: #ddd; }
        }

        .holden-history { margin-top: 14px; border-top: 1px solid #eee; padding-top: 12px; }
        .holden-history-item {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .holden-history-date { font-size: 0.85rem; color: #777; margin-bottom: 6px; }
        .holden-history-text { font-size: 0.95rem; line-height: 1.4; white-space: pre-wrap; word-wrap: break-word; }

        /* Global News */
        .news-updated {
            margin-top: 6px;
            color: #666;
            font-size: 0.95rem;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .news-updated .pill {
            background: #f6f6f6;
            border: 1px solid #eee;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .news-meta { color: #666; font-size: 0.95rem; margin-bottom: 14px; }
        .news-list { display: grid; grid-template-columns: 1fr; gap: 14px; }
        .news-card {
            border: 1px solid #e6e6e6;
            border-radius: 14px;
            padding: 14px 14px;
            background: #fff;
        }
        .news-title {
            font-size: 1.15rem;
            margin-bottom: 8px;
            line-height: 1.35;
        }
        .news-title a { color: #111; text-decoration: none; }
        .news-title a:hover { text-decoration: underline; }

        .news-kpis {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 14px;
            margin-top: 8px;
            color: #444;
            font-size: 0.95rem;
        }
        .kpi { background: #f6f6f6; border: 1px solid #eee; border-radius: 999px; padding: 6px 10px; }



        .news-card{ position: relative; }

        .rank-badge{
        position: absolute;
        top: 10px;
        right: 10px;
        background: #111;
        color: #fff;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.85rem;
        line-height: 1.2;
        }





        /* FAMILIER full-screen view */
        .familier-root {
            position: fixed;
            inset: 0;
            background-color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .familier-root img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }


        @media (max-width: 820px) {

            /* stack: content first, then bottom bar */
            .layout{
                flex-direction: column;
                height: auto;                /* allow natural page height */
                min-height: calc(100vh - 60px);
            }

            /* main content uses full width */
            .content{
                order: 1;
                padding: 16px;
            }

            /* sidebar turns into a bottom bar */
            .sidebar{
                order: 2;
                width: 100%;
                border-right: none;
                border-top: 1px solid #ccc;
                padding: 10px 12px;

                /* keep it visible at bottom */
                position: sticky;
                bottom: 0;
                background: #fff;
                z-index: 50;
            }

            /* hide the big portrait to save space (optional) */
            .sidebar img{
                display: none;
            }

            /* horizontal links instead of vertical list */
            .social-links{
                display: flex;
                gap: 14px;
                align-items: center;
                justify-content: space-between;
                flex-wrap: nowrap;
                overflow-x: auto;           /* swipe horizontally if needed */
                -webkit-overflow-scrolling: touch;
            }

            .social-links li{
                margin: 0;
                flex: 0 0 auto;
            }

            .social-links a{
                display: flex;
                align-items: center;
                gap: 8px;
                white-space: nowrap;
                padding: 8px 10px;
                border: 1px solid #eee;
                border-radius: 999px;
                background: #fafafa;
            }

            /* icons: remove the "top: 10px" mobile misalignment */
            .social-links a img{
                top: 0;
                margin-right: 0;
            }

            /* optional: tighten navbar on mobile */
            .navbar-inner{
                margin-left: 0;
            }
            .navbar{
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            .navbar a{
                margin-right: 12px;
            }
        }



    /* --- Top score history graph (worldnews) --- */
#scoreHistoryWrap{
    margin-top: 18px;
    border: 1px solid #e6e6e6;
    border-radius: 12px;
    padding: 12px;
    background: #fff;
}
#scoreHistoryHeader{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:12px;
    margin-bottom:10px;
}
#scoreHistoryScroll{
    overflow-x:auto;
    overflow-y:hidden;
    border: 1px solid #f0f0f0;
    border-radius: 10px;
    background: #fff;
}
#scoreHistorySvg{ display:block; }
#scoreTooltip{
    position: fixed;
    z-index: 9999;
    pointer-events: none;
    max-width: 520px;
    background: rgba(20,20,20,0.94);
    color: #fff;
    padding: 10px 12px;
    border-radius: 10px;
    font: 12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    line-height: 1.35;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    display: none;
}
#scoreTooltip .date { font-weight: 700; margin-bottom: 6px; }
#scoreTooltip ol { margin: 6px 0 0 18px; padding: 0; }
#scoreTooltip li { margin: 2px 0; }
.scoreTick { font: 11px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; fill:#666; }
.scoreLabel { font: 12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif; fill:#333; }

/* --- Regions legend + rainbow bar (worldnews) --- */
#regionLegendWrap{
  margin: 12px 0 14px;
  border: 1px solid #e6e6e6;
  border-radius: 12px;
  padding: 10px 12px;
  background: #fff;
}
#regionLegendTitle{
  font-weight: 700;
  margin-bottom: 8px;
}
#regionLegend{
  display: flex;
  flex-wrap: wrap;
  gap: 8px 10px;
  align-items: center;
}
.legend-item{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #eee;
  background: #fafafa;
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.92rem;
  color: #333;
}
.legend-dot{
  width: 10px;
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.15);
}

.region-bar{
  height: 10px;
  border-radius: 999px;
  overflow: hidden;
  border: 1px solid #eee;
  background: #fff;
  margin-top: 10px;
}
.region-bar-inner{
  display: flex;
  height: 100%;
}
.region-seg{
  height: 100%;
}

</style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-inner">
            <a href="#home" data-page="home">Ruben Lier</a>
            <a href="#preprints" data-page="preprints">Preprints</a>
            <a href="#talks" data-page="talks" id="nav-talks">Talks</a>
            <a href="#worldnews" data-page="worldnews">Global News</a>
            <!-- Notice: no link to #beta or #familier here on purpose -->
        </div>
    </div>

    <!-- Layout -->
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <img src="foto save ruben.PNG" alt="Ruben's Picture">
            <ul class="social-links">
                <li><a href="https://www.uva.nl/en/profile/l/i/r.lier/r.lier.html" target="_blank">
                    <img src="uvalogo.png" alt="Contact"><span>Contact</span></a></li>
                <li><a href="https://scholar.google.com/citations?user=jN3gPNkAAAAJ&hl=nl" target="_blank">
                    <img src="scholarlogo.png" alt="Google Scholar"><span>Google Scholar</span></a></li>
                <li><a href="https://nl.linkedin.com/in/ruben-lier-b228b2182" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/ca/LinkedIn_logo_initials.png" alt="LinkedIn"><span>LinkedIn</span></a></li>
                <li><a href="https://www.goodreads.com/user/show/131725587-ruben-lier" target="_blank">
                    <img src="goodreads.png" alt="Goodreads"><span>Goodreads</span></a></li>
                <li><a href="https://github.com/rubenlier" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/c/c2/GitHub_Invertocat_Logo.svg" alt="GitHub"><span>GitHub</span></a></li>
                <li><a href="https://open.spotify.com/playlist/4nSMm8TaDVlrNi4u9rzImQ" target="_blank">
                    <img src="spotify.png" alt="Spotify"><span>Spotify</span></a></li>
            </ul>
        </div>

        <!-- Main content -->
        <div class="content" id="content"></div>
    </div>

    <!-- FAMILIER full-screen picture -->
    <div id="familier-root" class="familier-root">
        <img src="familier.png" alt="Familier">
    </div>

    <script>
        // API endpoints (beta only)
        const HOLDEN_API_URL_BETA =
            "https://holden-hcaulfield-medium-416156146603.europe-west4.run.app/generate";


        // -----------------------------
        // Mobile guard: disable Talks page on phones
        // -----------------------------
        const isPhone = () => {
            // Your CSS switches to mobile layout at 820px; also treat "hover: none" devices as touch/phone.
            return window.matchMedia("(max-width: 820px)").matches || window.matchMedia("(hover: none)").matches;
        };

        function enforceNoTalksOnPhone() {
            const talksLink = document.getElementById("nav-talks") || document.querySelector('.navbar a[data-page="talks"]');

            if (isPhone()) {
                // 1) Hide the navbar link so users canâ€™t navigate there from other pages
                if (talksLink) talksLink.style.display = "none";

                // 2) If someone manually navigates to #talks, immediately bounce them back to Home
                if (window.location.hash === "#talks") {
                    window.location.hash = "#home";
                }
            } else {
                // Restore on desktop
                if (talksLink) talksLink.style.display = "";
            }
        }

        // Pages are HTML snippets injected into #content
        const pages = {
            home: `
                <h1>About me</h1>
                <p>
                    I am a theoretical physicist at the University of Amsterdam, specialized in problems
                    related to hydrodynamics, ranging from astrophysics to condensed matter physics and
                    from biophysics to high-energy physics.
                </p>
                <p>
                    Click "Preprints" in the top bar to learn about my recent scientific work.
                    Click "Talks" to see all the talks I have given.
                </p>
                <p>
                    Below is an animation of a numerical simulation that was part of my
                    <a href="https://journals.aps.org/prd/abstract/10.1103/stvc-tzfh" target="_blank">work</a> on magnetohydrodynamics.
                </p>
                <img src="animation.gif" alt="Hydrodynamic simulation" class="simulation-image">
            `,

            preprints: `
                <h1>My latest arXiv preprints</h1>
                <div id="preprints-container">
                    Loading latest arXiv papersâ€¦
                </div>
            `,

            talks: `
                <h1>Talks</h1>
                <p>
                    Hover your mouse over the flags to see when and where I have given a talk.
                </p>
                <div class="map-container">
                    <img class="world-map" src="equirel.jpg" alt="World Map" />

                    <!-- Flags: formula used: 100*{(90 - y)/180 - 0.052, (180 + x)/360 - 0.01} -->
                    <div class="flag-emoji" style="top: 18.70%; left: 51.40%;" data-tooltip="Odd Viscoelasticity Workshop (DIEP) â€“ 1 April 2022">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.00%; left: 51.40%;" data-tooltip="NWO Physics â€“ 23 Feb 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.20%; left: 52.80%;" data-tooltip="Max Planck Institute for Dynamics and Self-Organization â€“ 17 Sep 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.40%; left: 53.80%;" data-tooltip="Max Planck Institute for the Physics of Complex Systems â€“ 21 Sep 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 19.40%; left: 54.70%;" data-tooltip="WrocÅ‚aw University of Science and Technology â€“ 24 Jan 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 14.80%; left: 55.00%;" data-tooltip="Hydrodynamics at all scales (Nordita) â€“ 8 Sep 2023">ðŸš©</div>
                    <div class="flag-emoji" style="top: 21.30%; left: 16.00%;" data-tooltip="University of Washington â€“ 22 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.90%; left: 14.70%;" data-tooltip="University of Victoria â€“ 26 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 20.40%; left: 15.80%;" data-tooltip="University of British Columbia â€“ 15 Nov 2024">ðŸš©</div>
                    <div class="flag-emoji" style="top: 29.00%; left: 17.20%;" data-tooltip="APS Global Physics Summit â€“ 17 March 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 21.10%; left: 50.55%;" data-tooltip="Institut Curie â€“ 15 May 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 18.00%; left: 51.00%;" data-tooltip="DIEP Seminar (Amsterdam) â€“ 11 Sep 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 24.00%; left: 53.00%;" data-tooltip="UniversitÃ  di Genova â€“ 29 Oct 2025">ðŸš©</div>
                    <div class="flag-emoji" style="top: 29.50%; left: 61.00%;" data-tooltip="Tel Aviv University â€“ 1 Dec 2025">ðŸš©</div>
                </div>
            `,

            worldnews: `
    <h1>Global News</h1>
    



<div class="news-meta" id="worldnews-meta">Loading top clustersâ€¦</div>
    <div class="news-list" id="worldnews-list"></div>

  <div id="regionLegendWrap" style="display:none;">
    <div id="regionLegendTitle">Regions</div>
    <div id="regionLegend"></div>
  </div>

    <div id="scoreHistoryWrap">
      <div id="scoreHistoryHeader">
        <div><strong>Hover your mouse over the dots to see the 7 most important world events of that day.</strong></div>
        <div id="scoreHistoryMeta" class="scoreTick"></div>
      </div>

      <div id="scoreHistoryScroll">
        <svg id="scoreHistorySvg"></svg>
      </div>
    </div>

    <div id="scoreTooltip"></div>
`,

            // BETA PAGE (hidden route: #beta)
            beta: `
                <h1>Holdenator (beta)</h1>
                <p>Let Holden Caulfield finish your sentence.</p>

                <form id="holden-form" class="holden-form" autocomplete="off">
                    <input
                        id="holden-input"
                        class="holden-input"
                        type="text"
                        placeholder="If you really want to hear about it..."
                        required
                    />
                    <button type="submit" id="holden-submit" class="holden-button">
                        Talk to Holden
                    </button>
                </form>

                <p class="holden-status" id="holden-status"></p>

                <div class="holden-output">
                    <div class="holden-image-wrapper">
                        <img
                            src="holden.jpg"
                            alt="Holden Caulfield"
                            class="holden-image"
                        />
                        <div class="holden-speech-bubble">
                            <div id="holden-response" class="holden-response">
                                Iâ€™ll say something once you give me a prompt.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="holden-history" class="holden-history">
                    Loading historyâ€¦
                </div>
            `
        };






        async function loadPreprintsSnippet() {
            const container = document.getElementById('preprints-container');
            if (!container) return;

            try {
                const response = await fetch('paper.html', { cache: 'no-cache' });
                if (!response.ok) {
                    container.innerHTML = '<p>Could not load preprints at the moment.</p>';
                    return;
                }
                const html = await response.text();
                container.innerHTML = html;
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p>Error loading preprints.</p>';
            }
        }

        // --- helpers ---
        function escapeHtml(s) {
            return (s || "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        

// --- Region color mapping ---
const REGION_COLORS = {
  // Europe â†’ cool colors, but separated
  "Europe North": "#1f77b4",   // deep blue
  "Europe East":  "#9467bd",   // purple
  "Europe South": "#2eccb0",   // cyan / teal #17becf

  // Americas â†’ warm
  "North America": "#f1c40f",  // orange
  "South America": "#c49a6c",  // yellow-green  

  // Asia â†’ greens / yellows
  "Asia East": "#d62728",      // pink
  "China": "#e377c2",          // red
  "India": "#2ca02c",          // green (keeps it distinct)

  // Middle East / Africa / Oceania â†’ distinct earth & neutral tones
  "Middle East": "#bcbd22",    // brown
  "Africa": "#7f7f7f",        // neutral gray
  "Oceania": "#ff7f0e"         // yellow (new)
};


// Fallback color if you ever add a new label without updating REGION_COLORS
function colorForRegion(name){
  return REGION_COLORS[name] || "#111";
}

function uniqueStable(arr){
  const out = [];
  const seen = new Set();
  for (const x of (arr || [])){
    if (!x) continue;
    if (seen.has(x)) continue;
    seen.add(x);
    out.push(x);
  }
  return out;
}

function renderRegionLegend(regions){
  const wrap = document.getElementById("regionLegendWrap");
  const el = document.getElementById("regionLegend");
  if (!wrap || !el) return;

const regs = uniqueStable(regions);
  if (!regs.length){
    wrap.style.display = "none";
    el.innerHTML = "";
    return;
  }

  el.innerHTML = regs.map(r => `
    <span class="legend-item" title="${escapeHtml(r)}">
      <span class="legend-dot" style="background:${colorForRegion(r)};"></span>
      <span>${escapeHtml(r)}</span>
    </span>
  `).join("");

  wrap.style.display = "block";
}

// Build a rainbow bar from an ordered list of regions
function renderRegionBar(regions){
  const regs = uniqueStable(regions);
  if (!regs.length) return "";

  const n = regs.length;
  const segW = (100 / n);

  const segs = regs.map(r => `
    <div class="region-seg"
         style="width:${segW}%; background:${colorForRegion(r)};"
         title="${escapeHtml(r)}"></div>
  `).join("");

  return `
    <div class="region-bar" aria-label="Regions in this event">
      <div class="region-bar-inner">${segs}</div>
    </div>
  `;
}

function escapeRegExp(s) {
            return (s || "").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        // --- Global News loader ---
        async function loadWorldNews() {
          const metaEl = document.getElementById("worldnews-meta");
          const listEl = document.getElementById("worldnews-list");
          if (!metaEl || !listEl) return;

          metaEl.textContent = "Loading top clustersâ€¦";
          listEl.innerHTML = "";

          try {
            const res = await fetch("output.json", { cache: "no-store" });
            if (!res.ok) {
              throw new Error(`Could not load output.json (HTTP ${res.status})`);
            }

            const text = await res.text();

            // 1) Parse as JSON first (preferred)
            // 2) Fallback: JSONL (one JSON object per line)
            let parsed = null;

            try {
              parsed = JSON.parse(text);
            } catch (_) {
              const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
              const objs = [];
              for (const line of lines) {
                try { objs.push(JSON.parse(line)); } catch (e) {}
              }
              // If JSONL, treat as list of runs
              parsed = objs.length ? objs : null;
            }

            if (!parsed) {
              throw new Error("output.json is empty or not valid JSON.");
            }

            // Normalize to a list of runs
            const runs = Array.isArray(parsed) ? parsed : [parsed];

            // Keep only runs that look usable
            const validRuns = runs.filter(r => r && typeof r === "object" && Array.isArray(r.clusters));

            if (!validRuns.length) {
              throw new Error("output.json does not contain any run objects with a 'clusters' array.");
            }

            // Pick the latest run *for today* (UTC), fallback to latest overall.
            const isoDayUTC = (iso) => String(iso || "").slice(0, 10);
            const todayUTC = new Date().toISOString().slice(0, 10);

            const pickLatest = (arr) =>
              arr.slice().sort((a, b) => String(a.created_at_utc || "").localeCompare(String(b.created_at_utc || ""))).at(-1);

            const todaysRuns = validRuns.filter(r => isoDayUTC(r.created_at_utc) === todayUTC);
            const data = todaysRuns.length ? pickLatest(todaysRuns) : pickLatest(validRuns);

            if (!data || !Array.isArray(data.clusters)) {
              throw new Error("Could not select a valid run with clusters from output.json.");
            }

            const top = data.clusters.slice(0, 7);

            

// Fixed, complete legend (all regions, intentional order)
const REGION_ORDER = [
  "Europe North",
  "Europe South",
  "Europe East",
  "North America",
  "South America",
  "Middle East",
  "Africa",
  "Oceania",
  "India",
  "Asia East",
  "China"
];

renderRegionLegend(REGION_ORDER);

// Compute last update time from scraped_at_utc (max over clusters)
            const scrapedTimes = data.clusters
            .map(c => c?.central_article?.scraped_at_utc)
            .filter(Boolean)
            .map(s => new Date(s))
            .filter(d => !isNaN(d.getTime()));

            const lastScraped = scrapedTimes.length
            ? new Date(Math.max(...scrapedTimes.map(d => d.getTime())))
            : null;

            // Format in Amsterdam time nicely
            const fmtAMS = (d) => new Intl.DateTimeFormat("en-GB", {
            timeZone: "Europe/Amsterdam",
            year: "numeric",
            month: "short",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
            }).format(d);

            metaEl.innerHTML = `
            <div>Below are the 7 most important world events</div>
            <div class="news-updated">
                <span class="pill"><strong>Last updated:</strong> ${lastScraped ? fmtAMS(lastScraped) + " (Amsterdam)" : "unknown"}</span>
            </div>
            `;

            listEl.innerHTML = top.map((c, idx) => {
              const title = c.title || `Cluster ${idx + 1}`;
              const score = (typeof c.score === "number") ? c.score.toFixed(2) : c.score;
              const coherence = (typeof c.coherence === "number") ? c.coherence.toFixed(3) : c.coherence;

              const ca = c.central_article || {};
              const url = ca.url || "#";
              const source = ca.source_id || "";
              const continent = ca.continent || "";
              const scraped = ca.scraped_at_utc || "";
              const published = ca.published_at || "";

    const regions = (Array.isArray(c.continents) && c.continents.length)
      ? c.continents
      : (continent ? [continent] : []); // fallback for older runs



              return `
                <div class="news-card">

                    <div class="news-title">
                    <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
                      ${escapeHtml(title)}
                    </a>
                  </div>

                    <div class="news-kpis">
                    <span class="kpi">rank: ${idx + 1}</span>
                    <span class="kpi">score: ${escapeHtml(String(score))}</span>
                    <span class="kpi">sources: ${escapeHtml(String(c.n_sources ?? ""))}</span>
                    <span class="kpi">regions: ${escapeHtml(String(c.n_continents ?? ""))}</span>
                    </div>


                  
    ${renderRegionBar(regions)}

<div class="news-meta" style="margin-top:10px;">
                    <div>${escapeHtml(source)}${continent ? " Â· " + escapeHtml(continent) : ""}</div>
                    ${published ? `<div>published: ${escapeHtml(published)}</div>` : ""}
                  </div>
                </div>
              `;
            }).join("");

          } catch (err) {
            console.error(err);
            metaEl.textContent = "Could not load Global News.";
            listEl.innerHTML = `<p style="color:#b00;">${escapeHtml(err.message || String(err))}</p>`;
          }
        }





        // --- Holden history rendering ---
        async function loadHoldenHistory() {
            const container = document.getElementById("holden-history");
            if (!container) return;

            try {
                const res = await fetch("holden_history.html", { cache: "no-cache" });
                if (!res.ok) {
                    container.innerHTML = "<p>Could not load history.</p>";
                    return;
                }

                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, "text/html");
                const items = Array.from(doc.querySelectorAll("li"));

                if (!items.length) {
                    container.innerHTML = "<p>No history yet.</p>";
                    return;
                }

                container.innerHTML = items.map(li => {
                    const date = (li.querySelector("strong")?.textContent || "").trim();
                    const liHtml = li.innerHTML;

                    const promptMatch = liHtml.match(/<em>\s*Prompt:\s*<\/em>\s*([\s\S]*?)<br\s*\/?>/i);
                    const holdenMatch = liHtml.match(/<em>\s*Holden:\s*<\/em>\s*([\s\S]*)$/i);

                    const prompt = promptMatch ? promptMatch[1].replace(/<[^>]*>/g, "").trim() : "";
                    const holdenHtml = holdenMatch ? holdenMatch[1].trim() : "";

                    const tmp = document.createElement("div");
                    tmp.innerHTML = holdenHtml;
                    const holdenTextRaw = (tmp.textContent || "").trim();

                    let rendered;
                    if (prompt && holdenTextRaw.startsWith(prompt)) {
                        rendered =
                            "<strong>" + escapeHtml(prompt) + "</strong>" +
                            escapeHtml(holdenTextRaw.slice(prompt.length));
                    } else if (prompt && holdenTextRaw.includes(prompt)) {
                        rendered = escapeHtml(holdenTextRaw).replace(
                            new RegExp(escapeRegExp(prompt)),
                            "<strong>" + escapeHtml(prompt) + "</strong>"
                        );
                    } else {
                        rendered = escapeHtml(holdenTextRaw);
                    }

                    return `
                        <div class="holden-history-item">
                            <div class="holden-history-date">${escapeHtml(date)}</div>
                            <div class="holden-history-text">${rendered}</div>
                        </div>
                    `;
                }).join("");

            } catch (err) {
                console.error(err);
                container.innerHTML = "<p>Error loading history.</p>";
            }
        }

        function initHoldenatorBetaPage() {
            const form = document.getElementById("holden-form");
            if (!form) return;

            const input = document.getElementById("holden-input");
            const button = document.getElementById("holden-submit");
            const responseEl = document.getElementById("holden-response");
            const statusEl = document.getElementById("holden-status");

            const apiUrl = HOLDEN_API_URL_BETA;

            form.addEventListener("submit", async (event) => {
                event.preventDefault();

                const prompt = input.value.trim();
                if (!prompt) return;

                button.disabled = true;
                statusEl.textContent = "Holden is thinking...";
                responseEl.textContent = "â€¦";

                try {
                    const res = await fetch(apiUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt })
                    });

                    if (!res.ok) {
                        const bodyText = await res.text().catch(() => "");
                        throw new Error(`HTTP ${res.status} ${res.statusText} â€“ ${bodyText}`);
                    }

                    const data = await res.json();
                    responseEl.textContent = data.text || "";
                    statusEl.textContent = "";
                } catch (err) {
                    console.error("Holdenator error:", err);
                    responseEl.textContent =
                        "Sorry, Holdenâ€™s having a breakdown and canâ€™t answer right now.";
                    statusEl.textContent = err.message || "Error talking to the API.";
                } finally {
                    button.disabled = false;
                }
            });
        }

        function setActiveLink(page) {
            document.querySelectorAll('.navbar a[data-page]').forEach(a => {
                if (a.dataset.page === page) a.classList.add('active');
                else a.classList.remove('active');
            });
        }


        function pingWorldNewsOnce() {
            // prevent double-counting in same tab session
            if (sessionStorage.getItem("worldnews_pinged")) return;
            sessionStorage.setItem("worldnews_pinged", "1");

            fetch("https://uetmawaocxlgvjlyhwun.supabase.co/functions/v1/ping-worldnews", {
                method: "POST",
                headers: {
                "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVldG1hd2FvY3hsZ3ZqbHlod3VuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMjA2MjEsImV4cCI6MjA4MDU5NjYyMX0.sco4i7wqlwyRO0lGg0Mn9MgJGz8NvJ0tBCqnVpf5MgA",
                "X-Site-Token": "rubenlier-worldnews-v1",
                },
                keepalive: true,
            }).catch(() => {});
        }




        function loadPage(page) {
            // Block Talks on phones (even if hash is typed manually)
            if (page === 'talks' && isPhone()) {
                // Keep URL consistent too
                if (window.location.hash === '#talks') window.location.hash = '#home';
                page = 'home';
            }

            const navbar = document.querySelector('.navbar');
            const layout = document.querySelector('.layout');
            const familierRoot = document.getElementById('familier-root');
            const contentDiv = document.getElementById('content');

            // Special case: familier
            if (page === 'familier') {
                if (navbar) navbar.style.display = 'none';
                if (layout) layout.style.display = 'none';
                if (familierRoot) familierRoot.style.display = 'flex';
                return;
            }

            if (familierRoot) familierRoot.style.display = 'none';
            if (layout) layout.style.display = 'flex';

            if (!pages[page]) page = 'home';
            contentDiv.innerHTML = pages[page];

            if (page === 'beta') {
                if (navbar) navbar.style.display = 'none';
            } else {
                if (navbar) navbar.style.display = 'flex';
                setActiveLink(page);
            }

            if (page === 'preprints') {
                loadPreprintsSnippet();
            } else if (page === 'beta') {
                initHoldenatorBetaPage();
                loadHoldenHistory();
            } else if (page === 'worldnews') {
                loadWorldNews();
            if (typeof loadScoreHistoryGraph === 'function') loadScoreHistoryGraph();
                pingWorldNewsOnce();
            } else if (page === 'talks') {
                initTalksTooltips();
            }
        }

        function getPageFromHash() {
            const hash = window.location.hash.replace('#', '');
            return hash || 'home';
        }


        function initTalksTooltips(){
        const flags = Array.from(document.querySelectorAll(".flag-emoji"));
        if (!flags.length) return;

        // Make them keyboard/touch friendly
        for (const f of flags){
        f.setAttribute("role", "button");
        f.setAttribute("tabindex", "0");
        f.setAttribute("aria-label", f.getAttribute("data-tooltip") || "Talk");

        const toggle = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            // close others
            flags.forEach(x => { if (x !== f) x.classList.remove("is-open"); });
            // toggle current
            f.classList.toggle("is-open");
        };

        f.addEventListener("touchend", toggle, { passive: false });

        f.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") toggle(e);
        });
        }

        // tap anywhere else closes
        document.addEventListener("click", () => flags.forEach(x => x.classList.remove("is-open")));
        document.addEventListener("touchstart", () => flags.forEach(x => x.classList.remove("is-open")), { passive: true });
        }





        window.addEventListener('hashchange', () => {
            enforceNoTalksOnPhone();
            loadPage(getPageFromHash());
        });

        // Also react to viewport changes (rotate phone, resize window)
        window.addEventListener('resize', () => {
            enforceNoTalksOnPhone();
        }, { passive: true });

        enforceNoTalksOnPhone();

        loadPage(getPageFromHash());
    </script>
        <script>
    function escapeHtml(s) {
    return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function isoDayUTC(iso) {
    // "2026-01-03T20:56:50Z" -> "2026-01-03"
    return String(iso || "").slice(0, 10);
    }

    function pickLatestRun(runsForDay) {
    // created_at_utc is ISO UTC so lexicographic compare works
    return runsForDay
        .slice()
        .sort((a,b) => String(a.created_at_utc||"").localeCompare(String(b.created_at_utc||"")))
        .at(-1);
    }

    async function loadScoreHistoryGraph() {
    const metaEl = document.getElementById("scoreHistoryMeta");
    const svg = document.getElementById("scoreHistorySvg");
    const tooltip = document.getElementById("scoreTooltip");
    if (!metaEl || !svg || !tooltip) return;

    metaEl.textContent = "Loadingâ€¦";

    const res = await fetch("output.json", { cache: "no-store" });
    if (!res.ok) throw new Error(`Could not load output.json (HTTP ${res.status})`);

    const parsed = await res.json();
    const runs = Array.isArray(parsed) ? parsed : (parsed ? [parsed] : []);

    const valid = runs.filter(r => r && r.created_at_utc && Array.isArray(r.clusters) && r.clusters.length);
    if (!valid.length) {
        metaEl.textContent = "No runs with clusters yet.";
        svg.setAttribute("width", "760");
        svg.setAttribute("height", "120");
        svg.innerHTML = `<text x="10" y="30" class="scoreLabel">No data to plot.</text>`;
        return;
    }

    // Group by day, keep latest run per day
    const map = new Map();
    for (const r of valid) {
        const day = isoDayUTC(r.created_at_utc);
        if (!day) continue;
        if (!map.has(day)) map.set(day, []);
        map.get(day).push(r);
    }

    const days = Array.from(map.keys()).sort();
    const series = days.map(day => {
        const run = pickLatestRun(map.get(day));
        const topScore = Number(run?.clusters?.[0]?.score);
        if (!Number.isFinite(topScore)) return null;
        const top7titles = run.clusters.slice(0,7).map(c => c?.title ?? "(no title)");
        return { day, topScore, top7titles };
    }).filter(Boolean);

    if (!series.length) {
        metaEl.textContent = "No numeric scores found.";
        return;
    }

    metaEl.textContent = `Days: ${series.length}`;

    // ----- render SVG (wide + scroll) -----
    const NS = "http://www.w3.org/2000/svg";
    const margin = { top: 14, right: 18, bottom: 38, left: 56 };
    const daySpacing = 42;  // widen/narrow the graph per day
    const innerH = 220;
    const H = margin.top + innerH + margin.bottom;

    const W = Math.max(760, margin.left + margin.right + daySpacing * (series.length - 1));
    svg.setAttribute("width", String(W));
    svg.setAttribute("height", String(H));
    svg.innerHTML = "";

    const scores = series.map(p => p.topScore);
    const min = Math.min(...scores);
    const max = Math.max(...scores);
    const pad = (max - min) * 0.08 || 10;
    const yMin = min - pad;
    const yMax = max + pad;

    const xFor = (i) => margin.left + i * daySpacing;
    const yFor = (s) => {
        const t = (s - yMin) / (yMax - yMin);
        return margin.top + (1 - t) * innerH;
    };

    // background
    const bg = document.createElementNS(NS, "rect");
    bg.setAttribute("x","0"); bg.setAttribute("y","0");
    bg.setAttribute("width", String(W)); bg.setAttribute("height", String(H));
    bg.setAttribute("fill", "white");
    svg.appendChild(bg);

    // axes
    const xAxisY = margin.top + innerH;
    const axisLine = (x1,y1,x2,y2, color="#999") => {
        const l = document.createElementNS(NS, "line");
        l.setAttribute("x1", x1); l.setAttribute("y1", y1);
        l.setAttribute("x2", x2); l.setAttribute("y2", y2);
        l.setAttribute("stroke", color);
        l.setAttribute("stroke-width", "1");
        svg.appendChild(l);
    };
    axisLine(String(margin.left), String(margin.top), String(margin.left), String(xAxisY));
    axisLine(String(margin.left), String(xAxisY), String(W - margin.right), String(xAxisY));

    // y grid + ticks
    const ticks = 5;
    for (let i=0; i<=ticks; i++) {
        const t = i / ticks;
        const s = yMin + (1 - t) * (yMax - yMin);
        const y = yFor(s);

        axisLine(String(margin.left), String(y), String(W - margin.right), String(y), "#eee");

        const lab = document.createElementNS(NS, "text");
        lab.setAttribute("x", String(margin.left - 10));
        lab.setAttribute("y", String(y + 4));
        lab.setAttribute("text-anchor", "end");
        lab.setAttribute("class", "scoreTick");
        lab.textContent = (Math.round(s * 100) / 100).toString();
        svg.appendChild(lab);
    }



 // x labels: fewer + shorter (no rotation)
const formatDay = (day) => String(day || "").slice(5); // "2026-01-05" -> "01-05"
const labelEvery = Math.max(1, Math.ceil(series.length / 8)); // aim ~8 labels max

series.forEach((p, i) => {
  if (i % labelEvery !== 0 && i !== series.length - 1) return;

  const tx = document.createElementNS(NS, "text");
  tx.setAttribute("x", String(xFor(i)));
  tx.setAttribute("y", String(H - 12));
  tx.setAttribute("text-anchor", "middle");
  tx.setAttribute("class", "scoreTick");
  tx.textContent = formatDay(p.day);
  svg.appendChild(tx);
});



    // line path
    const path = document.createElementNS(NS, "path");
    const d = series.map((p,i) => `${i===0?"M":"L"} ${xFor(i)} ${yFor(p.topScore)}`).join(" ");
    path.setAttribute("d", d);
    path.setAttribute("fill", "none");
    path.setAttribute("stroke", "#111");
    path.setAttribute("stroke-width", "1.6");
    svg.appendChild(path);

// dots + tooltip
let activeDot = null; // track which dot is "locked open" on touch

const showTip = (ev, p) => {
  const items = p.top7titles.map(t => `<li>${escapeHtml(t)}</li>`).join("");
  tooltip.innerHTML = `
    <div class="date">${escapeHtml(p.day)} â€” top score: ${escapeHtml(p.topScore.toFixed(2))}</div>
    <div>Top 7 events:</div>
    <ol>${items}</ol>
  `;
  tooltip.style.display = "block";
  requestAnimationFrame(() => moveTip(ev));
};

const moveTip = (ev) => {
  const offset = 14;
  const rect = tooltip.getBoundingClientRect();

  let left = ev.clientX + offset;
  let top  = ev.clientY - rect.height - offset;

  if (top < 8) top = ev.clientY + offset;

  if (left + rect.width > window.innerWidth - 8) {
    left = ev.clientX - rect.width - offset;
  }
  if (left < 8) left = 8;

  if (top + rect.height > window.innerHeight - 8) {
    top = window.innerHeight - rect.height - 8;
  }

  tooltip.style.left = left + "px";
  tooltip.style.top  = top + "px";
};

const hideTip = () => {
  tooltip.style.display = "none";
  activeDot = null;
};

// IMPORTANT: close when tapping/clicking anywhere else
// (capture phase helps on mobile where SVG handling can be quirky)
document.addEventListener("pointerdown", (e) => {
  // If the tap is on a dot, the dot handler will run and stopPropagation().
  // Otherwise, close.
  hideTip();
}, { capture: true });

// Also close on scroll/resize so it never gets "orphaned"
const scrollWrap = document.getElementById("scoreHistoryScroll");
if (scrollWrap) scrollWrap.addEventListener("scroll", hideTip, { passive: true });
window.addEventListener("resize", hideTip, { passive: true });

series.forEach((p,i) => {
  const c = document.createElementNS(NS, "circle");
  c.setAttribute("cx", String(xFor(i)));
  c.setAttribute("cy", String(yFor(p.topScore)));
  c.setAttribute("r", "4.2");
  c.setAttribute("fill", "#111");
  c.style.cursor = "pointer";

  // Desktop hover still works
  c.addEventListener("mouseenter", (ev) => showTip(ev, p));
  c.addEventListener("mousemove", (ev) => moveTip(ev));
  c.addEventListener("mouseleave", () => {
    // only hide on leave if we didn't "lock" it open via tap
    if (activeDot !== c) hideTip();
  });

  // Touch/mobile: tap toggles open/closed and "locks" it open
  c.addEventListener("pointerdown", (ev) => {
    ev.preventDefault();
    ev.stopPropagation(); // prevents the document handler from immediately closing it

    if (activeDot === c && tooltip.style.display === "block") {
      hideTip();          // tap same dot again -> close
      return;
    }

    activeDot = c;
    showTip(ev, p);
  });

  svg.appendChild(c);
});

    }

    loadScoreHistoryGraph().catch(err => {
    const metaEl = document.getElementById("scoreHistoryMeta");
    if (metaEl) metaEl.textContent = "Graph failed: " + (err.message || String(err));
    console.error(err);
    });
    </script>

</body>
</html>
